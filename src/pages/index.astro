---
import Layout from "../layouts/Layout.astro";
import "./index.scss";
import logo from "../assets/logo.png";
import PagesDisplay from "../components/PagesDisplay.astro";
---

<Layout
  ><div class="home-page">
    <div class="sidebar">
      <div class="mobile-header">
        <img src={logo.src} alt="" class="mobile-logo" />
        <h1>SCREENING FORM</h1>
      </div>
      <img src={logo.src} alt="" class="desktop-logo" />
      <PagesDisplay />
    </div>
    <h1 class="thank-you">Thank you for your submission!</h1>
    <div class="content">
      <div class="container">
        <h1>SCREENING FORM</h1>
        <form action="">
          <!-- <input
            type="hidden"
            name="access_key"
            value="f4205424-50b4-4b5c-8459-71f768ddeb89"
            class="luke-key"
          /> -->
          <input
            type="hidden"
            name="access_key"
            value="476cb9f1-a26b-4da6-b5e9-c463c81ae288"
          />

          <div class="page first-page active-page" id="0">
            <h2>Personal Information</h2>
            <div class="form-field">
              <label for="full-name">Full Name</label>
              <input
                type="text"
                name="full-name"
                placeholder="John Doe"
                required
              />
            </div>
            <div class="form-field">
              <label for="date-of-birth">Date of Birth</label>
              <input type="date" name="date-of-birth" required />
            </div>
            <div class="form-field">
              <label for="phone-number">Phone Number</label>
              <input
                type="tel"
                name="phone-number"
                placeholder="(123) 456-7890"
                required
              />
            </div>
            <div class="form-field">
              <label for="phone-number">Email</label>
              <input
                type="text"
                name="email"
                placeholder="john@example.com"
                required
              />
            </div>
            <div class="form-field">
              <label for="occupation">Current Employer & Occupation</label>
              <input
                name="occupation"
                placeholder="San Juan Medical Center, Nurse"
                class="input-full-width"
                required
              />
            </div>
          </div>
          <div class="page second-page" id="1">
            <h2>Tenant History</h2>
            <div class="form-field">
              <label for="date-of-birth">Planned Move-in Date</label>
              <input type="date" name="move-in" required />
            </div>
            <div class="form-field">
              <label for="date-of-birth">Planned Move-Out Date</label>
              <input type="date" name="move-out" required />
            </div>
            <fieldset>
              <legend
                >Have you declared bankruptcy in the past 7 years?
              </legend>
              <input
                type="radio"
                name="bankruptcy"
                value="yes"
                class="radio"
                required
              />
              <label for="yes">Yes</label>
              <input
                type="radio"
                name="bankruptcy"
                value="no"
                class="radio"
                required
              />
              <label for="no">No</label>
            </fieldset>
            <fieldset>
              <legend
                >Have you ever been evicted from a rental residence?
              </legend>
              <input
                type="radio"
                name="evicted"
                value="yes"
                class="radio"
                required
              />
              <label for="yes">Yes</label>
              <input
                type="radio"
                name="evicted"
                value="no"
                class="radio"
                required
              />
              <label for="no">No</label>
            </fieldset>
            <fieldset>
              <legend
                >Have you had two or more late rental payments in the past year?
              </legend>
              <input
                type="radio"
                name="payments"
                value="yes"
                class="radio"
                required
              />
              <label for="yes">Yes</label>
              <input
                type="radio"
                name="payments"
                value="no"
                class="radio"
                required
              />
              <label for="no">No</label>
            </fieldset>
            <fieldset>
              <legend
                >Have you been convicted of a felony in the past 10 years?
              </legend>
              <input
                type="radio"
                name="felony"
                value="yes"
                class="radio"
                required
              />
              <label for="yes">Yes</label>
              <input
                type="radio"
                name="felony"
                value="no"
                class="radio"
                required
              />
              <label for="no">No</label>
            </fieldset>
          </div>
          <div class="page third-page" id="2">
            <h2>Previous Rental Information</h2>
            <div class="form-field">
              <label for="landlord"
                >Current Landlord Reference Information</label
              >
              <input
                type="text"
                name="landlord"
                placeholder="John Doe, 123-456-7890"
                required
              />
            </div>
            <div class="form-field">
              <label for="address">Current Address</label>
              <input
                type="text"
                name="address"
                placeholder="123 Main St, Albuquerque, NM 12345"
                required
              />
            </div>
            <div class="form-field">
              <label for="previous"> Previous Address </label>
              <input
                type="text"
                name="previous"
                placeholder="123 Main St, Albuquerque, NM 12345"
                required
              />
            </div>
            <div class="form-field">
              <label for="reason"> Reason for Leaving Previous Address: </label>
              <input
                name="reason"
                placeholder="Changed jobs"
                type="text"
                required
              />
            </div>
          </div>
          <div class="page fourth-page" id="3">
            <h2>Misc. Information</h2>
            <fieldset>
              <legend>Are there any roommates? </legend>
              <input
                type="radio"
                name="felony"
                value="yes"
                class="radio"
                required
              />
              <label for="yes">Yes</label>
              <input
                type="radio"
                name="felony"
                value="no"
                class="radio"
                required
              />
              <label for="no">No</label>
            </fieldset>
            <div class="form-field">
              <label for="interests"
                >What are some hobbies or interests that you currently have?</label
              >
              <input
                type="text"
                name="interests"
                placeholder="Running, hiking, etc."
                class="input-full-width"
                required
              />
            </div>
            <!-- <fieldset>
              <legend class="legend-italic"
                >Do you understand that this is a single family home that is
                split in 2 (with sliding door) and you will have complete
                privacy and control over the living room and kitchen area and
                not have to share anything?
              </legend>
              <input
                type="radio"
                name="understand"
                value="yes"
                class="radio"
                required
              />
              <label for="yes">Yes</label>
              <input
                type="radio"
                name="understand"
                value="no"
                class="radio"
                required
              />
              <label for="no">No</label>
            </fieldset> -->
            <button type="submit" class="submit-button">Submit</button>
            <div class="error-message">
              <span class="material-symbols-outlined"> error </span><div
                class="error-text"
              >
                Please fill out all required fields
              </div>
            </div>
          </div>
        </form>
        <div class="buttons">
          <button class="prev"
            ><span class="material-symbols-outlined"> arrow_back </span></button
          >
          <button class="next"
            ><span class="material-symbols-outlined">
              arrow_forward
            </span></button
          >
        </div>
      </div>
    </div>
  </div></Layout
>

<script>
  let invalidFormAttempted = false;
  async function handleFormSubmit() {
    const form = document.querySelector("form");
    if (!form) return;

    form.addEventListener(
      "invalid",
      function (event) {
        event.preventDefault();
        if (invalidFormAttempted) {
          const errorMessage = document.querySelector(
            ".error-message",
          ) as HTMLDivElement;
          if (!errorMessage) return;
          errorMessage.style.display = "flex";
          form.classList.add("attempted-submit");
          invalidFormAttempted = true;
          const pages = document.querySelectorAll(".page");
          for (const page of pages) {
            if (page.querySelector("input:invalid")) {
              const li = document.getElementById(`li-${page.id}`);
              li?.classList.add("invalid-li");
            }
          }
        }
      },
      true,
    );

    document
      .querySelector('button[type="submit"]')
      ?.addEventListener("click", () => {
        invalidFormAttempted = true;
      });

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      invalidFormAttempted = false;
      console.log("trying to submit...");
      const formData = new FormData(form);
      type Web3FormsResponse = {
        success: boolean;
        message: string;
        data: any;
      };
      const submitButton = document.querySelector(
        'button[type="submit"]',
      ) as HTMLButtonElement;
      if (!submitButton) return;
      submitButton.disabled = true;
      const response = await fetch("https://api.web3forms.com/submit", {
        method: "POST",
        body: formData,
      });
      const responseData: Web3FormsResponse = await response.json();
      if (responseData.success) {
        const content = document.querySelector(".content") as HTMLDivElement;
        if (!content) return;
        content.style.display = "none";
        const thankYou = document.querySelector(".thank-you") as HTMLDivElement;
        thankYou.style.display = "block";
      } else {
        const errorMessage = document.querySelector(
          ".error-message",
        ) as HTMLDivElement;
        if (!errorMessage) return;
        errorMessage.style.display = "flex";
        const errorText = document.querySelector(
          ".error-text",
        ) as HTMLDivElement;
        if (!errorText) return;
        errorText.textContent = "Failed to send form. Please try again.";
        submitButton.disabled = false;
      }
    });
  }

  const inputs = document.querySelectorAll("input");
  for (const input of inputs) {
    input.addEventListener("change", () => {
      if (!invalidFormAttempted) return;
      const pages = document.querySelectorAll(".page");
      for (const page of pages) {
        if (!page.querySelector("input:invalid")) {
          const errorMessage = document.querySelector(
            ".error-message",
          ) as HTMLDivElement;
          errorMessage.style.display = "none";
        }
      }
      if (input.checkValidity()) {
        const parentPage = input.closest(".page");
        const pageInputs = parentPage?.querySelectorAll("input");
        if (!pageInputs || !parentPage) return;
        let invalid = false;
        for (const pageInput of pageInputs) {
          if (!pageInput.checkValidity()) {
            invalid = true;
          }
        }
        if (!invalid) {
          const li = document.getElementById(`li-${parentPage.id}`);
          li?.classList.remove("invalid-li");
        }
      }
    });
  }

  handleFormSubmit();
</script>

<script>
  function nextPage() {
    const element = document.querySelector(".active-page");
    const currentPage = element?.id;
    if (!currentPage) return;
    if (+currentPage >= 3) return;
    const currentLi = document.getElementById(`li-${currentPage}`);
    currentLi?.classList.remove("active-li");
    element?.classList.remove("active-page");
    const nextPage = +currentPage + 1;
    const nextElement = document.getElementById(`${nextPage}`);
    nextElement?.classList.add("active-page");
    const form = document.querySelector("form");
    if (!form) return;
    const incrementWidth = window.innerWidth > 850 ? 448 : window.innerWidth;
    form.style.transform = `translateX(-${incrementWidth * +nextPage}px)`;
    const nextLi = document.getElementById(`li-${nextPage}`);
    nextLi?.classList.add("active-li");
  }

  function prevPage() {
    const element = document.querySelector(".active-page");
    const currentPage = element?.id;
    if (currentPage === "0") return;
    if (!currentPage) return;
    const currentLi = document.getElementById(`li-${currentPage}`);
    currentLi?.classList.remove("active-li");
    element?.classList.remove("active-page");
    const prevPage = +currentPage - 1;
    const prevElement = document.getElementById(`${prevPage}`);
    prevElement?.classList.add("active-page");
    const form = document.querySelector("form");
    if (!form) return;
    const incrementWidth = window.innerWidth > 850 ? 448 : window.innerWidth;
    form.style.transform = `translateX(-${incrementWidth * +prevPage}px)`;
    const prevLi = document.getElementById(`li-${prevPage}`);
    prevLi?.classList.add("active-li");
  }

  function jumpToPage(li: Element) {
    const page = li.id.split("-")[1];
    const element = document.querySelector(".active-page");
    const currentPage = element?.id;
    if (!currentPage) return;
    const currentLi = document.getElementById(`li-${currentPage}`);
    currentLi?.classList.remove("active-li");
    element?.classList.remove("active-page");
    const nextElement = document.getElementById(`${page}`);
    nextElement?.classList.add("active-page");
    const form = document.querySelector("form");
    if (!form) return;
    const incrementWidth = window.innerWidth > 850 ? 448 : window.innerWidth;
    form.style.transform = `translateX(-${incrementWidth * +page}px)`;
    const nextLi = document.getElementById(`li-${page}`);
    nextLi?.classList.add("active-li");
  }

  function addEventListeners() {
    const nextButton = document.querySelector(".next");
    const prevButton = document.querySelector(".prev");
    nextButton?.addEventListener("click", nextPage);
    prevButton?.addEventListener("click", prevPage);
    const lis = document.querySelectorAll(".pages-display li");
    for (const li of lis) {
      li.addEventListener("click", () => {
        jumpToPage(li);
      });
    }
  }

  addEventListeners();
</script>
